---
title: 'Lab 1: Question 1'
author: "Jun Qian, Lucas Schroyer, Ryan Mitchell, Oliver Chang"
output: pdf_document
---

```{r load packages, echo=TRUE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2) 
library(purrr)
library(haven)
library(tidyverse)
# install.packages("DescTools")
library(DescTools)
```

```{r load data, echo=FALSE, warning=TRUE, message=FALSE}
## read in initial data frame
# https://electionstudies.org/data-center/2020-time-series-study/

# codebook
# https://electionstudies.org/wp-content/uploads/2021/02/anes_timeseries_2020_userguidecodebook_20210211.pdf
anes_timeseries_2020_stata_20210211 <- read_dta("Data/anes_timeseries_2020_stata_20210211.dta")
labelled_df <- anes_timeseries_2020_stata_20210211

names_list <- c()
id_list <- c()
for (var_tmp in names(labelled_df)) {
  name_tmp <- attributes(zap_labels(labelled_df[[var_tmp]]))$label
  id_list <- c(id_list, var_tmp)
  names_list <- c(names_list, name_tmp)
}

names_list %>% head()

id_key <- data.frame("id" = id_list, "desc" = names_list)
View(id_key)

rm(names_list, id_list)


```

``` {r clean data, echo=FALSE, warning=TRUE, message=FALSE}
# The study interviewed respondents in a pre-election survey that was
# conducted between August 18, 2020 and November 3, 2020. Election day was
# November 3, 2020. The study re-interviewed as many as possible of the same
# respondents in a post-election survey that was conducted between November 8,
# 2020 and January 4, 2021.

# The data should be analyzed using weights to accurately represent the population.
# Sampling errors should be calculated using methods that account for the complex
# sample design and the effects of weighting on variance.

# For analysis of the complete pre-election dataset,
# including all cases and representative of the 2020 electorate, use the full sample
# weight, V200010a. This weight is for the full pre-election
# dataset, consisting of the combination of sample groups for the webonly, mixed web, and mixed video modes, and the 2016-2020 panel cases combined. Most analyses should use this weight unless the sample group is intended to be limited to one of the subsets below

# What are weighted datasets?
# 
# Weighted datasets are frequently found in survey research because the respondents to a survey are sampled from a larger population of interest. The respondents to the sample represent themselves and others in their "weight class" who were not included in the sample. So the weights essentially inflate (or deflate) the value for each row in the dataset to represent the population.

anes_timeseries_raw <- anes_timeseries_2020_stata_20210211 %>% 
  select(weight_all_samples = V200010a,
         variance_unit = V200010b,
         variance_stratum = V200010c,
         interview_type = V200002,
         sample_type = V200003,
            # 2. ANES 2016-2020 Panel
            # 3. 3Ar1 Fresh sample: web only, replicate 1
            # 4. 3Ar2 Fresh sample: web only, replicate 2
            # 5. 3B Fresh sample: web or phone
            # 6. 3C Fresh sample: video, web, or phone
         # ----key filters----#
         registered_to_vote_loc = V201008,
         
         # ----question 1 fields ----#
         # Democrat vs Republican Age in 2020
         party_of_registration = V201018,
         democratic_party_rating = V201156,
         republican_party_rating = V201157,
         age = V201507x,
         
         # ----question 2 fields ----#
         # Democratic voters excited about Joe Biden or Kamala Harris
         biden_rating = V201151,
         harris_rating = V201153,
         biden_likability = V201106,
         biden_dislikability = V201108,
         biden_leadership_skills = V201208,
         biden_caring_for_people = V201209,
         biden_knowledgeable = V201210,
         biden_honest = V201211,

         
         # ----question 3 fields ----#
         # Covid household approval of governor's handleing of the pandemic
         voted_for_governor = V201066,
         voted_for_governor2 = V201067,
         voted_for_governor3 = V201070,
         voted_for_governor4 = V201073,
         gov_approval_covid_response = V201145,
         gov_approval_covid_response2 = V201146,
         covid_household_tested = V201624,
         covid_household_suspected = V201625
         ) %>% 
  mutate(
    interview_type2 = as.integer(zap_labels(interview_type)),
    party_of_registration2 = as.integer(zap_labels(party_of_registration))) %>% 
  mutate(
    interview_type_char = case_when(
      `interview_type2` == 1 ~ "Video",
      `interview_type2` == 2 ~ "Telephone",
      `interview_type2` == 3 ~ "Web",
      T ~ "NA"),
    registered_to_vote_status = case_when(
      registered_to_vote_loc %in% c(1,2) ~ T,
      registered_to_vote_loc == 3 ~ F,
      T ~ NA),
    party_of_registration_str = case_when(
      party_of_registration2 == 1 ~ "Democrat",
      party_of_registration2 == 2 ~ "Republican",
      party_of_registration2 == 4 ~ "None_or_independent",
      party_of_registration2 == 5 ~ "other",
      T ~ "NA")
    ) %>% 
  select(-interview_type2, -party_of_registration2)

#save raw data for scripts 02 and 03
saveRDS(anes_timeseries_raw, file = "Data/anes_key_fields.rds")

anes_timeseries_raw %>% glimpse()

```


## Importance and Context
<!-- You can (and should delete each of these comments lines in your final report) --> 
<!-- Explain why the reader should care about your research question. -->

1. Are Democratic voters older or younger than Republican voters in 2020?



## Description of Data
<!-- Explain how your research question is operationalized, including whether the variables you create are appropriate to study the concepts in question. --> 
<!-- What are some basic features of the data distribution? --> 
<!-- What changes do you make to the data and why? --> 

```{r q1 exploratory analysis, echo=FALSE, warning=TRUE, message=FALSE}

anes_timeseries_q1 <- anes_timeseries_raw

#Option 1
Hmisc::wtd.table(anes_timeseries_raw$party_of_registration_str, 
          weights = anes_timeseries_raw$weight_all_samples,
          normwt = FALSE)
#Option 2
party_counts <- tapply(anes_timeseries_raw$weight_all_samples, 
       anes_timeseries_raw$party_of_registration_str, 
       sum) %>% 
  as.data.frame()

party_counts <- cbind(newColName = rownames(party_counts), party_counts)
rownames(party_counts) <- 1:nrow(party_counts)
names(party_counts) <- c("party", "sample_count_weighted")
party_counts_2 <- party_counts %>% 
  mutate(sample_freq_weighted = sample_count_weighted/sum(sample_count_weighted) * 100) %>% 
  arrange(desc(sample_freq_weighted)) 

party_counts_2
```


## Most appropriate test 
<!-- Explain which test is the most appropriate to answer your question and why it is the most appropriate --> 
<!-- List every assumption that your test requires and evaluate it. -->

Rank summed approach (to account for the 80 + years variable)


## Test, results and interpretation
<!-- What are the results of your test? --> 
<!-- What do the results of this test mean? What is the practical significance? --> 